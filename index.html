<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RCI Engine - DeepSeek V3 & Qwen3 Dual Model System</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              500: '#5686f5',
              600: '#4f46e5',
              700: '#4338ca',
            },
            deepseek: {
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgb(20, 24, 33);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(14, 165, 233, 0.6);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(14, 165, 233, 0.8);
    }

    /* Animation classes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
    }
    
    .fade-in {
      animation: fadeIn 0.4s ease;
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    /* Code highlighting enhancements */
    .hljs {
      background: #0d1117 !important;
      padding: 1.5rem !important;
      border-radius: 0.5rem !important;
      margin: 1rem 0 !important;
    }

    /* Message styling */
    .message-content {
      max-width: none !important;
    }

    .message-content pre {
      overflow-x: auto;
      margin: 1rem 0;
    }

    .message-content code {
      background: #374151;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-family: 'JetBrains Mono', monospace;
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
    }

    /* Stage indicators */
    .stage-header {
      background: linear-gradient(135deg, rgba(86, 134, 245, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
      border: 1px solid rgba(86, 134, 245, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .stage-deepseek {
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-color: rgba(14, 165, 233, 0.3);
    }

    .stage-qwen {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
      border-color: rgba(147, 51, 234, 0.3);
    }

    .stage-final {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-color: rgba(34, 197, 94, 0.3);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-gradient-to-b from-gray-800 to-gray-900 border-r border-gray-700 flex flex-col hidden md:flex shadow-2xl">
      <!-- Header -->
      <div class="p-6 border-b border-gray-700">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-gradient-to-r from-deepseek-500 to-primary-600 rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-lg font-bold text-white">RCI Engine</h2>
            <p class="text-xs text-deepseek-400">DeepSeek V3 + Qwen3 System</p>
          </div>
        </div>
        
        <button id="newSessionBtn" class="w-full bg-gradient-to-r from-deepseek-500 to-primary-600 hover:from-deepseek-600 hover:to-primary-700 text-white py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="font-medium">New Coding Project</span>
        </button>
      </div>

      <!-- Model Status -->
      <div class="p-4 border-b border-gray-700">
        <div class="space-y-3">
          <!-- DeepSeek Status -->
          <div class="bg-gradient-to-r from-deepseek-900/20 to-blue-900/20 border border-deepseek-500/30 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div id="deepseekIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-deepseek-300 text-sm font-medium">DeepSeek V3</span>
                <span class="bg-blue-500/20 text-blue-300 text-xs px-2 py-1 rounded-full">Primary</span>
              </div>
            </div>
            <div class="text-deepseek-200 text-xs">Code Analysis & Generation</div>
          </div>
          
          <!-- Qwen Status -->
          <div class="bg-gradient-to-r from-purple-900/20 to-pink-900/20 border border-purple-500/30 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div id="qwenIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-purple-300 text-sm font-medium">Qwen3 30B</span>
                <span class="bg-purple-500/20 text-purple-300 text-xs px-2 py-1 rounded-full">Critic</span>
              </div>
            </div>
            <div class="text-purple-200 text-xs">Code Review & Improvement</div>
          </div>

          <!-- RCI Status -->
          <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-500/30 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div id="rciIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-green-300 text-sm font-medium">RCI Status</span>
              </div>
            </div>
            <div id="rciStatus" class="text-green-200 text-xs">Ready</div>
          </div>
        </div>
      </div>

      <!-- Sessions -->
      <div class="flex-1 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Sessions</h3>
          <span id="sessionCount" class="text-xs bg-gray-700 text-gray-400 px-2 py-1 rounded-full">0</span>
        </div>
        <div id="sessionList" class="space-y-2">
          <div class="text-center text-gray-500 text-sm mt-8">No sessions yet</div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="p-4 border-t border-gray-700 space-y-3">
        <button id="exportCodeBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-3 border border-gray-600 hover:border-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span class="text-sm">Export Code</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-6">
        <h1 class="text-xl font-semibold">RCI Engine - Dual Model Coding Assistant</h1>
        <div class="flex items-center gap-3">
          <div class="bg-gray-700 text-sm px-3 py-1.5 rounded-lg flex items-center gap-2">
            <div class="w-2 h-2 bg-gradient-to-r from-deepseek-400 to-purple-400 rounded-full animate-pulse"></div>
            <span>Dual Model Active</span>
          </div>
        </div>
      </header>

      <!-- Progress Bar -->
      <div id="progressContainer" class="bg-gray-700 h-2 overflow-hidden hidden">
        <div id="progressBar" class="bg-gradient-to-r from-deepseek-500 to-primary-600 h-full w-0 transition-all duration-300"></div>
      </div>

      <!-- Chat Messages -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-6">
        <div class="text-center text-gray-500 mt-12">
          <div class="w-16 h-16 bg-gradient-to-r from-deepseek-500 to-primary-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-300 mb-2">Ready to Code</h3>
          <p class="text-gray-400">Describe your coding project and let our dual-model system create it for you.</p>
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-6 border-t border-gray-700 bg-gray-800">
        <div class="flex items-start gap-3 rounded-xl bg-gray-700 p-3 shadow-lg border border-gray-600 focus-within:border-deepseek-500 transition">
          <div class="flex-1">
            <textarea id="userInput" rows="1" class="w-full bg-gray-800 text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-deepseek-500 resize-none text-base" placeholder="Describe your coding project - I'll analyze, create, and improve it for you..."></textarea>
          </div>
          <button id="sendBtn" class="bg-gradient-to-r from-deepseek-500 to-primary-600 hover:from-deepseek-600 hover:to-primary-700 text-white p-3 rounded-lg transition" title="Send message">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading notification -->
  <div id="loadingNotification" class="fixed bottom-4 right-4 bg-gray-800 text-white py-3 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 hidden">
    <div class="flex items-center gap-3">
      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-deepseek-400"></div>
      <span id="loadingText">Processing...</span>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      apiEndpoint: '/api/chat',
      models: {
        deepseek: 'deepseek',
        qwen: 'qwen'
      }
    };

    // Enhanced RCI Prompts with better structure
    const RCI_PROMPTS = {
      // Stage 1: DeepSeek Analysis & Code Generation
      deepseekAnalysis: `You are DeepSeek V3, an expert coding assistant. Analyze the user's request and generate comprehensive, production-ready code.

## Your Task:
1. **Understand Requirements**: Analyze what the user wants to build
2. **Plan Architecture**: Design the solution structure
3. **Generate Complete Code**: Create working, well-documented code
4. **Add Best Practices**: Include error handling, security, and performance considerations

## Output Format:
Provide a complete implementation with:
- Clear explanation of the approach
- Full working code with comments
- Usage examples
- Setup/installation instructions

Focus on creating robust, maintainable code that follows industry standards.`,

      // Stage 2: Qwen Code Review & Critique
      qwenCritique: `You are Qwen3, a senior code reviewer. Analyze the provided code and identify specific improvements.

## Review Areas:
1. **Bugs & Issues**: Find logical errors, edge cases, missing validation
2. **Security**: Identify vulnerabilities, input sanitization issues
3. **Performance**: Spot inefficiencies, bottlenecks, optimization opportunities
4. **Code Quality**: Check structure, readability, maintainability
5. **Missing Features**: Identify incomplete implementations

## Output Format:
Provide specific, actionable feedback:
- List concrete issues found
- Suggest specific improvements
- Prioritize critical vs. minor issues
- Recommend better approaches where applicable

Be thorough but focus on the most impactful improvements.`,

      // Stage 3: Final Implementation
      finalImplementation: `You are DeepSeek V3. Create the final, improved version incorporating all feedback from the code review.

## Your Task:
1. **Address All Issues**: Fix every problem identified in the review
2. **Implement Suggestions**: Apply all recommended improvements
3. **Enhance Features**: Add any missing functionality
4. **Optimize Performance**: Apply performance improvements
5. **Ensure Quality**: Make code production-ready

## Output Format:
Provide the complete, final implementation:
- Full working code with all improvements
- Clear documentation
- Usage examples
- Deployment instructions

This should be the definitive, production-ready version.`
    };

    // Session Management
    let sessions = [];
    let currentSessionId = null;
    let sessionCounter = 1;
    let currentStage = 0;

    class Session {
      constructor() {
        this.id = Date.now();
        this.name = `Project ${sessionCounter++}`;
        this.messages = [];
        this.codeBlocks = [];
        this.created = new Date().toISOString();
        this.stage1Response = '';
        this.stage2Response = '';
        this.stage3Response = '';
      }
    }

    // UI Elements
    const elements = {
      chatMessages: document.getElementById('chatMessages'),
      userInput: document.getElementById('userInput'),
      sendBtn: document.getElementById('sendBtn'),
      newSessionBtn: document.getElementById('newSessionBtn'),
      sessionList: document.getElementById('sessionList'),
      sessionCount: document.getElementById('sessionCount'),
      exportCodeBtn: document.getElementById('exportCodeBtn'),
      progressContainer: document.getElementById('progressContainer'),
      progressBar: document.getElementById('progressBar'),
      loadingNotification: document.getElementById('loadingNotification'),
      loadingText: document.getElementById('loadingText'),
      deepseekIndicator: document.getElementById('deepseekIndicator'),
      qwenIndicator: document.getElementById('qwenIndicator'),
      rciIndicator: document.getElementById('rciIndicator'),
      rciStatus: document.getElementById('rciStatus')
    };

    // Initialize Application
    function initializeApp() {
      createNewSession();
      setupEventListeners();
      updateModelStatus('ready');
      console.log('🚀 RCI Engine initialized');
    }

    // Event Listeners
    function setupEventListeners() {
      elements.sendBtn.addEventListener('click', handleSendMessage);
      elements.newSessionBtn.addEventListener('click', createNewSession);
      elements.exportCodeBtn.addEventListener('click', exportCode);
      
      elements.userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });

      // Auto-resize textarea
      elements.userInput.addEventListener('input', () => {
        elements.userInput.style.height = 'auto';
        elements.userInput.style.height = elements.userInput.scrollHeight + 'px';
      });
    }

    // Session Management
    function createNewSession() {
      const session = new Session();
      sessions.push(session);
      currentSessionId = session.id;
      currentStage = 0;
      updateSessionList();
      clearChat();
      showWelcomeMessage();
      updateModelStatus('ready');
    }

    function updateSessionList() {
      elements.sessionCount.textContent = sessions.length;
      
      if (sessions.length === 0) {
        elements.sessionList.innerHTML = '<div class="text-center text-gray-500 text-sm mt-8">No sessions yet</div>';
        return;
      }

      elements.sessionList.innerHTML = sessions.map(session => `
        <div class="session-item ${session.id === currentSessionId ? 'bg-gray-600' : 'bg-gray-700'} hover:bg-gray-600 text-gray-300 px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 border border-gray-600 hover:border-gray-500" 
             data-session-id="${session.id}">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-deepseek-500/20 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-deepseek-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-white truncate">${session.name}</p>
              <p class="text-xs text-gray-400">${formatTimeAgo(session.created)}</p>
            </div>
          </div>
        </div>
      `).join('');

      // Add click listeners
      document.querySelectorAll('.session-item').forEach(item => {
        item.addEventListener('click', () => {
          const sessionId = parseInt(item.dataset.sessionId);
          switchToSession(sessionId);
        });
      });
    }

    function switchToSession(sessionId) {
      currentSessionId = sessionId;
      updateSessionList();
      renderCurrentSession();
    }

    function getCurrentSession() {
      return sessions.find(s => s.id === currentSessionId);
    }

    // Message Handling
    async function handleSendMessage() {
      const message = elements.userInput.value.trim();
      if (!message) return;

      const session = getCurrentSession();
      if (!session) return;

      // Add user message
      addMessage('user', message);
      elements.userInput.value = '';
      elements.userInput.style.height = 'auto';

      // Process with RCI system
      await processWithRCI(message);
    }

    async function processWithRCI(userMessage) {
      try {
        showProgress();
        currentStage = 1;
        updateModelStatus('processing');

        // Stage 1: DeepSeek Analysis & Code Generation
        await runStage1(userMessage);
        
        // Stage 2: Qwen Code Review
        await runStage2(userMessage);
        
        // Stage 3: Final Implementation
        await runStage3();

        // Complete
        updateModelStatus('complete');
        showCompletionMessage();

      } catch (error) {
        console.error('❌ RCI Processing Error:', error);
        addMessage('system', `**Error**: ${error.message}

Please try again or check your API configuration.`, 'error');
        updateModelStatus('error');
      } finally {
        hideProgress();
        hideLoading();
        currentStage = 0;
      }
    }

    async function runStage1(userMessage) {
      try {
        updateModelStatus('stage1');
        showLoading('🧠 DeepSeek V3 analyzing requirements and generating code...');
        updateProgress(25);

        const response = await callAPI(CONFIG.models.deepseek, [
          { role: 'system', content: RCI_PROMPTS.deepseekAnalysis },
          { role: 'user', content: userMessage }
        ]);

        const session = getCurrentSession();
        session.stage1Response = response;

        addMessage('assistant', response, 'deepseek-analysis', '🚀 Stage 1: DeepSeek V3 Analysis & Code Generation');
        updateProgress(40);
        
        // Extract code blocks from Stage 1
        extractCodeBlocks(response);
        
        console.log('✅ Stage 1 completed');
      } catch (error) {
        console.error('❌ Stage 1 error:', error);
        throw new Error(`Stage 1 failed: ${error.message}`);
      }
    }

    async function runStage2(userMessage) {
      try {
        updateModelStatus('stage2');
        showLoading('🔍 Qwen3 reviewing code quality and identifying improvements...');
        
        const session = getCurrentSession();
        const stage1Response = session.stage1Response;

        const reviewPrompt = `**ORIGINAL REQUEST:**
${userMessage}

**CODE TO REVIEW:**
${stage1Response}

Please provide a detailed code review with specific improvements.`;

        const response = await callAPI(CONFIG.models.qwen, [
          { role: 'system', content: RCI_PROMPTS.qwenCritique },
          { role: 'user', content: reviewPrompt }
        ]);

        session.stage2Response = response;

        addMessage('assistant', response, 'qwen-critique', '🔍 Stage 2: Qwen3 Code Review & Critique');
        updateProgress(70);
        
        console.log('✅ Stage 2 completed');
      } catch (error) {
        console.error('❌ Stage 2 error:', error);
        throw new Error(`Stage 2 failed: ${error.message}`);
      }
    }

    async function runStage3() {
      try {
        updateModelStatus('stage3');
        showLoading('⚡ Creating final optimized implementation...');
        
        const session = getCurrentSession();
        const stage1Response = session.stage1Response;
        const stage2Response = session.stage2Response;

        const finalPrompt = `**ORIGINAL CODE:**
${stage1Response}

**CODE REVIEW & IMPROVEMENTS:**
${stage2Response}

Generate the final, improved implementation addressing all feedback.`;

        const response = await callAPI(CONFIG.models.deepseek, [
          { role: 'system', content: RCI_PROMPTS.finalImplementation },
          { role: 'user', content: finalPrompt }
        ]);

        session.stage3Response = response;

        addMessage('assistant', response, 'final-implementation', '✨ Stage 3: Final Optimized Implementation');
        updateProgress(100);
        
        // Extract code blocks from final implementation
        extractCodeBlocks(response);
        
        console.log('✅ Stage 3 completed');
      } catch (error) {
        console.error('❌ Stage 3 error:', error);
        throw new Error(`Stage 3 failed: ${error.message}`);
      }
    }

    // API Communication with enhanced error handling
    async function callAPI(model, messages) {
      try {
        console.log(`🔄 Calling ${model} API...`);
        
        const response = await fetch(CONFIG.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model,
            messages,
            temperature: 0.3,
            max_tokens: 4096,
            top_p: 0.9,
            top_k: 40
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage;
          
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.message || errorData.error || 'API request failed';
          } catch {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          
          throw new Error(errorMessage);
        }

        const data = await response.json();
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
          throw new Error('Invalid API response format');
        }

        console.log(`✅ ${model} API call successful`);
        return data.choices[0].message.content;
        
      } catch (error) {
        console.error(`❌ API Error (${model}):`, error);
        throw error;
      }
    }

    // Model Status Management
    function updateModelStatus(status) {
      const { deepseekIndicator, qwenIndicator, rciIndicator, rciStatus } = elements;
      
      // Reset all indicators
      deepseekIndicator.className = 'w-2 h-2 rounded-full';
      qwenIndicator.className = 'w-2 h-2 rounded-full';
      rciIndicator.className = 'w-2 h-2 rounded-full';
      
      switch (status) {
        case 'ready':
          deepseekIndicator.classList.add('bg-gray-400');
          qwenIndicator.classList.add('bg-gray-400');
          rciIndicator.classList.add('bg-green-400');
          rciStatus.textContent = 'Ready';
          break;
        case 'processing':
        case 'stage1':
          deepseekIndicator.classList.add('bg-deepseek-400', 'animate-pulse');
          qwenIndicator.classList.add('bg-gray-400');
          rciIndicator.classList.add('bg-yellow-400', 'animate-pulse');
          rciStatus.textContent = 'Stage 1: Analysis';
          break;
        case 'stage2':
          deepseekIndicator.classList.add('bg-deepseek-400');
          qwenIndicator.classList.add('bg-purple-400', 'animate-pulse');
          rciIndicator.classList.add('bg-yellow-400', 'animate-pulse');
          rciStatus.textContent = 'Stage 2: Review';
          break;
        case 'stage3':
          deepseekIndicator.classList.add('bg-deepseek-400', 'animate-pulse');
          qwenIndicator.classList.add('bg-purple-400');
          rciIndicator.classList.add('bg-yellow-400', 'animate-pulse');
          rciStatus.textContent = 'Stage 3: Final';
          break;
        case 'complete':
          deepseekIndicator.classList.add('bg-green-400');
          qwenIndicator.classList.add('bg-green-400');
          rciIndicator.classList.add('bg-green-400');
          rciStatus.textContent = 'Complete';
          break;
        case 'error':
          deepseekIndicator.classList.add('bg-red-400');
          qwenIndicator.classList.add('bg-red-400');
          rciIndicator.classList.add('bg-red-400');
          rciStatus.textContent = 'Error';
          break;
      }
    }

    // UI Functions with enhanced message rendering
    function addMessage(sender, content, type = 'default', stageInfo = '') {
      const session = getCurrentSession();
      if (!session) return;

      const message = {
        id: Date.now(),
        sender,
        content,
        type,
        stageInfo,
        timestamp: new Date().toISOString()
      };

      session.messages.push(message);
      renderMessage(message);
      scrollToBottom();
    }

    function renderMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message fade-in ${message.sender === 'user' ? 'user-message' : 'assistant-message'}`;
      
      if (message.sender === 'user') {
        messageDiv.innerHTML = `
          <div class="bg-gray-700 rounded-lg p-4 max-w-3xl ml-auto">
            <div class="text-gray-100">${escapeHtml(message.content)}</div>
          </div>
        `;
      } else {
        const stageClass = getStageClass(message.type);
        const stageIcon = getStageIcon(message.type);
        
        messageDiv.innerHTML = `
          <div class="max-w-6xl w-full">
            ${message.stageInfo ? `
              <div class="stage-header ${stageClass} mb-4">
                <div class="flex items-center gap-3">
                  <div class="text-lg">${stageIcon}</div>
                  <div>
                    <div class="font-semibold text-white">${message.stageInfo}</div>
                    <div class="text-xs text-gray-300 mt-1">${formatTimestamp(message.timestamp)}</div>
                  </div>
                </div>
              </div>
            ` : ''}
            <div class="bg-gray-800 rounded-lg p-6 border-l-4 ${getBorderColor(message.type)}">
              <div class="message-content prose prose-invert max-w-none">${formatMessage(message.content)}</div>
            </div>
          </div>
        `;
      }
      
      elements.chatMessages.appendChild(messageDiv);
      
      // Highlight code blocks after rendering
      setTimeout(() => {
        messageDiv.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      }, 100);
    }

    function getStageClass(type) {
      const classes = {
        'deepseek-analysis': 'stage-deepseek',
        'qwen-critique': 'stage-qwen',
        'final-implementation': 'stage-final',
        'error': 'stage-error'
      };
      return classes[type] || '';
    }

    function getStageIcon(type) {
      const icons = {
        'deepseek-analysis': '🚀',
        'qwen-critique': '🔍',
        'final-implementation': '✨',
        'error': '❌'
      };
      return icons[type] || '💬';
    }

    function getBorderColor(type) {
      const colors = {
        'deepseek-analysis': 'border-deepseek-500',
        'qwen-critique': 'border-purple-500',
        'final-implementation': 'border-green-500',
        'error': 'border-red-500'
      };
      return colors[type] || 'border-gray-500';
    }

    function formatMessage(content) {
      // Enhanced markdown processing
      try {
        // Configure marked with better options
        marked.setOptions({
          highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
              try {
                return hljs.highlight(code, { language: lang }).value;
              } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
          },
          breaks: true,
          gfm: true
        });
        
        return marked.parse(content);
      } catch (error) {
        console.error('Markdown parsing error:', error);
        return escapeHtml(content).replace(/\n/g, '<br>');
      }
    }

    function extractCodeBlocks(content) {
      const session = getCurrentSession();
      if (!session) return;

      const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
      let match;
      
      while ((match = codeBlockRegex.exec(content)) !== null) {
        const language = match[1] || 'text';
        const code = match[2].trim();
        
        if (code.length > 10) {
          session.codeBlocks.push({
            id: Date.now() + Math.random(),
            language,
            code,
            timestamp: new Date().toISOString()
          });
        }
      }
    }

    function renderCurrentSession() {
      clearChat();
      const session = getCurrentSession();
      if (!session) return;

      if (session.messages.length === 0) {
        showWelcomeMessage();
        return;
      }

      session.messages.forEach(renderMessage);
      scrollToBottom();
    }

    function clearChat() {
      elements.chatMessages.innerHTML = '';
    }

    function showWelcomeMessage() {
      elements.chatMessages.innerHTML = `
        <div class="text-center text-gray-500 mt-12">
          <div class="w-16 h-16 bg-gradient-to-r from-deepseek-500 to-primary-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-300 mb-2">Ready to Code</h3>
          <p class="text-gray-400">Describe your coding project and let our dual-model system create it for you.</p>
          <div class="mt-6 text-sm text-gray-500">
            <p><strong>How it works:</strong></p>
            <p>🚀 DeepSeek V3 analyzes & generates initial code</p>
            <p>🔍 Qwen3 reviews & identifies improvements</p>
            <p>✨ Final optimized implementation delivered</p>
          </div>
        </div>
      `;
    }

    function showCompletionMessage() {
      setTimeout(() => {
        addMessage('system', `🎉 **RCI Process Complete!**

All three stages have been executed successfully:
- ✅ Stage 1: Requirements analysis and initial code generation
- ✅ Stage 2: Comprehensive code review and improvement identification  
- ✅ Stage 3: Final optimized implementation

Your code is ready for use! Check the export section to download the complete implementation.`, 'success');
      }, 1000);
    }

    function scrollToBottom() {
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    // Progress and Loading
    function showProgress() {
      elements.progressContainer.classList.remove('hidden');
      updateProgress(0);
    }

    function hideProgress() {
      setTimeout(() => {
        elements.progressContainer.classList.add('hidden');
      }, 2000);
    }

    function updateProgress(percent) {
      elements.progressBar.style.width = `${percent}%`;
    }

    function showLoading(text) {
      elements.loadingText.textContent = text;
      elements.loadingNotification.classList.remove('hidden');
      elements.loadingNotification.style.opacity = '1';
    }

    function hideLoading() {
      elements.loadingNotification.style.opacity = '0';
      setTimeout(() => {
        elements.loadingNotification.classList.add('hidden');
      }, 300);
    }

    // Export Functions
    function exportCode() {
      const session = getCurrentSession();
      if (!session || session.codeBlocks.length === 0) {
        alert('No code to export in current session');
        return;
      }

      let content = `# ${session.name} - RCI Generated Code\n`;
      content += `Generated: ${new Date().toLocaleString()}\n`;
      content += `RCI Engine: DeepSeek V3 + Qwen3 Dual Model System\n\n`;
      content += `${'='.repeat(60)}\n\n`;
      
      // Add all stages
      if (session.stage1Response) {
        content += `## Stage 1: DeepSeek V3 Analysis & Initial Code\n\n${session.stage1Response}\n\n`;
        content += `${'='.repeat(60)}\n\n`;
      }
      
      if (session.stage2Response) {
        content += `## Stage 2: Qwen3 Code Review & Critique\n\n${session.stage2Response}\n\n`;
        content += `${'='.repeat(60)}\n\n`;
      }
      
      if (session.stage3Response) {
        content += `## Stage 3: Final Optimized Implementation\n\n${session.stage3Response}\n\n`;
        content += `${'='.repeat(60)}\n\n`;
      }
      
      // Add extracted code blocks
      if (session.codeBlocks.length > 0) {
        content += `## Extracted Code Blocks\n\n`;
        session.codeBlocks.forEach((block, index) => {
          content += `### Code Block ${index + 1} (${block.language})\n\n`;
          content += '```' + block.language + '\n';
          content += block.code;
          content += '\n```\n\n';
        });
      }
      
      downloadFile(content, `${session.name.replace(/\s+/g, '_')}_RCI_Complete.md`, 'text/markdown');
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // Utility Functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTimeAgo(timestamp) {
      const now = new Date();
      const then = new Date(timestamp);
      const diffMs = now - then;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}h ago`;
      
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}d ago`;
    }

    function formatTimestamp(timestamp) {
      return new Date(timestamp).toLocaleTimeString();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // Enhanced error handling for the entire application
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      updateModelStatus('error');
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      updateModelStatus('error');
    });
  </script>
</body>
</html>
